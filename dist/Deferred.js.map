{"version":3,"file":"Deferred.js","sources":["../node_modules/port-authority/dist/port-authority.esm.js"],"sourcesContent":["import { exec as exec$1 } from 'child_process';\nimport { createServer, createConnection, connect } from 'net';\n\nfunction exec(cmd) {\n\treturn new Promise((fulfil, reject) => {\n\t\texec$1(cmd, (error, stdout, stderr) => {\n\t\t\tif (error) return reject(error);\n\t\t\tfulfil({ stdout, stderr });\n\t\t});\n\t});\n}\n\nasync function blame(port) {\n\ttry {\n\t\tconst { stdout } = await exec(`lsof -i :${port} -sTCP:LISTEN -Fp`);\n\n\t\tif (!stdout) return null;\n\t\tconst pid = parseInt(stdout.slice(1), 10);\n\t\tif (isNaN(pid)) throw new Error(`Invalid stdout ${stdout}`);\n\n\t\treturn pid;\n\t} catch (error) {\n\t\treturn null;\n\t}\n}\n\nlet promise;\n\nfunction weird() {\n\tif (!promise) {\n\t\tpromise = get_weird(9000);\n\t}\n\treturn promise;\n}\n\nfunction get_weird(port) {\n\treturn new Promise(fulfil => {\n\t\tconst server = createServer();\n\n\t\tserver.unref();\n\n\t\tserver.on('error', () => {\n\t\t\tfulfil(get_weird(port + 1));\n\t\t});\n\n\t\tserver.listen({ port }, () => {\n\t\t\tconst server2 = createServer();\n\n\t\t\tserver2.unref();\n\n\t\t\tserver2.on('error', () => {\n\t\t\t\tserver.close(() => {\n\t\t\t\t\tfulfil(false);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tserver2.listen({ port }, () => {\n\t\t\t\tserver2.close(() => {\n\t\t\t\t\tserver.close(() => {\n\t\t\t\t\t\tfulfil(true);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n}\n\nfunction check(port) {\n\treturn weird().then(weird => {\n\t\tif (weird) {\n\t\t\treturn check_weird(port);\n\t\t}\n\n\t\treturn new Promise(fulfil => {\n\t\t\tconst server = createServer();\n\n\t\t\tserver.unref();\n\n\t\t\tserver.on('error', () => {\n\t\t\t\tfulfil(false);\n\t\t\t});\n\n\t\t\tserver.listen({ port }, () => {\n\t\t\t\tserver.close(() => {\n\t\t\t\t\tfulfil(true);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n}\n\nfunction check_weird(port) {\n\treturn new Promise(fulfil => {\n\t\tconst client = createConnection({ port }, () => {\n\t\t\t\tclient.end();\n\t\t\t\tfulfil(false);\n\t\t\t})\n\t\t\t.on('error', () => {\n\t\t\t\tfulfil(true);\n\t\t\t});\n\t});\n}\n\nfunction find(port) {\n\treturn weird().then(weird => {\n\t\tif (weird) {\n\t\t\treturn new Promise(fulfil => {\n\t\t\t\tget_port_weird(port, fulfil);\n\t\t\t});\n\t\t}\n\t\treturn new Promise(fulfil => {\n\t\t\tget_port(port, fulfil);\n\t\t});\n\t});\n}\n\nfunction get_port(port, cb) {\n\tconst server = createServer();\n\n\tserver.unref();\n\n\tserver.on('error', () => {\n\t\tget_port(port + 1, cb);\n\t});\n\n\tserver.listen({ port }, () => {\n\t\tserver.close(() => {\n\t\t\tcb(port);\n\t\t});\n\t});\n}\n\nfunction get_port_weird(port, cb) {\n\tconst client = createConnection({ port }, () => {\n\t\t\tclient.end();\n\t\t\tget_port(port + 1, cb);\n\t\t})\n\t\t.on('error', () => {\n\t\t\tcb(port);\n\t\t});\n}\n\nasync function kill(port) {\n\tconst pid = await blame(port);\n\tif (!pid) return false;\n\n\tawait exec$1(`kill ${pid}`);\n\treturn true;\n}\n\nfunction wait(port, { timeout = 5000 } = {}) {\n\treturn new Promise((fulfil, reject) => {\n\t\tconst t = setTimeout(() => {\n\t\t\treject(new Error(`timed out waiting for connection`));\n\t\t}, timeout);\n\n\t\tget_connection(port, () => {\n\t\t\tclearTimeout(t);\n\t\t\tfulfil();\n\t\t});\n\t});\n}\n\nfunction get_connection(port, cb) {\n\tlet timeout;\n\n\tconst socket = connect(port, 'localhost', () => {\n\t\tcb();\n\t\tsocket.destroy();\n\t\tclearTimeout(timeout);\n\t});\n\n\tsocket.on('error', () => {\n\t\tclearTimeout(timeout);\n\t\tsetTimeout(() => {\n\t\t\tget_connection(port, cb);\n\t\t}, 10);\n\t});\n\n\ttimeout = setTimeout(() => {\n\t\tsocket.destroy();\n\t}, 5000);\n}\n\nexport { blame, check, find, kill, wait };\n"],"names":["createServer","createConnection","connect"],"mappings":";;;;;AA0BA,IAAI,OAAO,CAAC;AACZ;AACA,SAAS,KAAK,GAAG;AACjB,CAAC,IAAI,CAAC,OAAO,EAAE;AACf,EAAE,OAAO,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;AAC5B,EAAE;AACF,CAAC,OAAO,OAAO,CAAC;AAChB,CAAC;AACD;AACA,SAAS,SAAS,CAAC,IAAI,EAAE;AACzB,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,IAAI;AAC9B,EAAE,MAAM,MAAM,GAAGA,gBAAY,EAAE,CAAC;AAChC;AACA,EAAE,MAAM,CAAC,KAAK,EAAE,CAAC;AACjB;AACA,EAAE,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC3B,GAAG,MAAM,CAAC,SAAS,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,CAAC;AAC/B,GAAG,CAAC,CAAC;AACL;AACA,EAAE,MAAM,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AAChC,GAAG,MAAM,OAAO,GAAGA,gBAAY,EAAE,CAAC;AAClC;AACA,GAAG,OAAO,CAAC,KAAK,EAAE,CAAC;AACnB;AACA,GAAG,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC7B,IAAI,MAAM,CAAC,KAAK,CAAC,MAAM;AACvB,KAAK,MAAM,CAAC,KAAK,CAAC,CAAC;AACnB,KAAK,CAAC,CAAC;AACP,IAAI,CAAC,CAAC;AACN;AACA,GAAG,OAAO,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AAClC,IAAI,OAAO,CAAC,KAAK,CAAC,MAAM;AACxB,KAAK,MAAM,CAAC,KAAK,CAAC,MAAM;AACxB,MAAM,MAAM,CAAC,IAAI,CAAC,CAAC;AACnB,MAAM,CAAC,CAAC;AACR,KAAK,CAAC,CAAC;AACP,IAAI,CAAC,CAAC;AACN,GAAG,CAAC,CAAC;AACL,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,KAAK,CAAC,IAAI,EAAE;AACrB,CAAC,OAAO,KAAK,EAAE,CAAC,IAAI,CAAC,KAAK,IAAI;AAC9B,EAAE,IAAI,KAAK,EAAE;AACb,GAAG,OAAO,WAAW,CAAC,IAAI,CAAC,CAAC;AAC5B,GAAG;AACH;AACA,EAAE,OAAO,IAAI,OAAO,CAAC,MAAM,IAAI;AAC/B,GAAG,MAAM,MAAM,GAAGA,gBAAY,EAAE,CAAC;AACjC;AACA,GAAG,MAAM,CAAC,KAAK,EAAE,CAAC;AAClB;AACA,GAAG,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC5B,IAAI,MAAM,CAAC,KAAK,CAAC,CAAC;AAClB,IAAI,CAAC,CAAC;AACN;AACA,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AACjC,IAAI,MAAM,CAAC,KAAK,CAAC,MAAM;AACvB,KAAK,MAAM,CAAC,IAAI,CAAC,CAAC;AAClB,KAAK,CAAC,CAAC;AACP,IAAI,CAAC,CAAC;AACN,GAAG,CAAC,CAAC;AACL,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,WAAW,CAAC,IAAI,EAAE;AAC3B,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,IAAI;AAC9B,EAAE,MAAM,MAAM,GAAGC,oBAAgB,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AAClD,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;AACjB,IAAI,MAAM,CAAC,KAAK,CAAC,CAAC;AAClB,IAAI,CAAC;AACL,IAAI,EAAE,CAAC,OAAO,EAAE,MAAM;AACtB,IAAI,MAAM,CAAC,IAAI,CAAC,CAAC;AACjB,IAAI,CAAC,CAAC;AACN,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,IAAI,CAAC,IAAI,EAAE;AACpB,CAAC,OAAO,KAAK,EAAE,CAAC,IAAI,CAAC,KAAK,IAAI;AAC9B,EAAE,IAAI,KAAK,EAAE;AACb,GAAG,OAAO,IAAI,OAAO,CAAC,MAAM,IAAI;AAChC,IAAI,cAAc,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AACjC,IAAI,CAAC,CAAC;AACN,GAAG;AACH,EAAE,OAAO,IAAI,OAAO,CAAC,MAAM,IAAI;AAC/B,GAAG,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AAC1B,GAAG,CAAC,CAAC;AACL,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,QAAQ,CAAC,IAAI,EAAE,EAAE,EAAE;AAC5B,CAAC,MAAM,MAAM,GAAGD,gBAAY,EAAE,CAAC;AAC/B;AACA,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;AAChB;AACA,CAAC,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC1B,EAAE,QAAQ,CAAC,IAAI,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC;AACzB,EAAE,CAAC,CAAC;AACJ;AACA,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AAC/B,EAAE,MAAM,CAAC,KAAK,CAAC,MAAM;AACrB,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC;AACZ,GAAG,CAAC,CAAC;AACL,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,cAAc,CAAC,IAAI,EAAE,EAAE,EAAE;AAClC,CAAC,MAAM,MAAM,GAAGC,oBAAgB,CAAC,EAAE,IAAI,EAAE,EAAE,MAAM;AACjD,GAAG,MAAM,CAAC,GAAG,EAAE,CAAC;AAChB,GAAG,QAAQ,CAAC,IAAI,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC;AAC1B,GAAG,CAAC;AACJ,GAAG,EAAE,CAAC,OAAO,EAAE,MAAM;AACrB,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC;AACZ,GAAG,CAAC,CAAC;AACL,CAAC;AASD;AACA,SAAS,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO,GAAG,IAAI,EAAE,GAAG,EAAE,EAAE;AAC7C,CAAC,OAAO,IAAI,OAAO,CAAC,CAAC,MAAM,EAAE,MAAM,KAAK;AACxC,EAAE,MAAM,CAAC,GAAG,UAAU,CAAC,MAAM;AAC7B,GAAG,MAAM,CAAC,IAAI,KAAK,CAAC,CAAC,gCAAgC,CAAC,CAAC,CAAC,CAAC;AACzD,GAAG,EAAE,OAAO,CAAC,CAAC;AACd;AACA,EAAE,cAAc,CAAC,IAAI,EAAE,MAAM;AAC7B,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;AACnB,GAAG,MAAM,EAAE,CAAC;AACZ,GAAG,CAAC,CAAC;AACL,EAAE,CAAC,CAAC;AACJ,CAAC;AACD;AACA,SAAS,cAAc,CAAC,IAAI,EAAE,EAAE,EAAE;AAClC,CAAC,IAAI,OAAO,CAAC;AACb;AACA,CAAC,MAAM,MAAM,GAAGC,WAAO,CAAC,IAAI,EAAE,WAAW,EAAE,MAAM;AACjD,EAAE,EAAE,EAAE,CAAC;AACP,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;AACnB,EAAE,YAAY,CAAC,OAAO,CAAC,CAAC;AACxB,EAAE,CAAC,CAAC;AACJ;AACA,CAAC,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AAC1B,EAAE,YAAY,CAAC,OAAO,CAAC,CAAC;AACxB,EAAE,UAAU,CAAC,MAAM;AACnB,GAAG,cAAc,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;AAC5B,GAAG,EAAE,EAAE,CAAC,CAAC;AACT,EAAE,CAAC,CAAC;AACJ;AACA,CAAC,OAAO,GAAG,UAAU,CAAC,MAAM;AAC5B,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;AACnB,EAAE,EAAE,IAAI,CAAC,CAAC;AACV;;;;;;;;;;;;;;;;"}