{"version":3,"file":"CheapWatch.es.js","sources":["../node_modules/cheap-watch/dist/CheapWatch.es.js"],"sourcesContent":["import * as EventEmitter from 'events';\nimport { readdir, stat, watch } from 'fs';\nimport { promisify } from 'util';\n\nconst readdir$1 = promisify(readdir);\nconst stat$1 = promisify(stat);\nclass CheapWatch extends EventEmitter {\n    constructor(data) {\n        super();\n        this.watch = true;\n        this.debounce = 10;\n        this.paths = new Map();\n        this._watchers = new Map();\n        this._timeouts = new Map();\n        this._queue = [];\n        this._status = 0;\n        Object.assign(this, data);\n        if (typeof this.dir !== 'string') {\n            throw new TypeError('dir must be a string');\n        }\n        if (this.filter && typeof this.filter !== 'function') {\n            throw new TypeError('filter must be a function');\n        }\n        if (typeof this.watch !== 'boolean') {\n            throw new TypeError('watch must be a boolean');\n        }\n        if (typeof this.debounce !== 'number') {\n            throw new TypeError('debounce must be a number');\n        }\n    }\n    async init() {\n        if (this._status !== 0) {\n            throw new Error('cannot call init() twice');\n        }\n        this._status = 1;\n        await this._recurse(this.dir);\n        this._status = 2;\n    }\n    close() {\n        if (this._status === 0 || this._status === 1) {\n            throw new Error('cannot call close() before init() finishes');\n        }\n        if (this._status === 4) {\n            throw new Error('cannot call close() twice');\n        }\n        this._status = 4;\n        for (const watcher of this._watchers.values()) {\n            watcher.close();\n        }\n    }\n    async _recurse(full) {\n        const path = full.slice(this.dir.length + 1);\n        const stats = await stat$1(full);\n        if (path) {\n            if (this.filter && !(await this.filter({ path, stats }))) {\n                return;\n            }\n            this.paths.set(path, stats);\n        }\n        if (stats.isDirectory()) {\n            if (this.watch) {\n                this._watchers.set(path, watch(full, this._handle.bind(this, full)).on('error', () => { }));\n            }\n            await Promise.all((await readdir$1(full)).map(sub => this._recurse(full + '/' + sub)));\n        }\n    }\n    _handle(dir, event, file) {\n        this._debounce(dir);\n        this._debounce(dir + '/' + file);\n    }\n    _debounce(path) {\n        if (this._timeouts.has(path)) {\n            clearTimeout(this._timeouts.get(path));\n        }\n        this._timeouts.set(path, setTimeout(() => {\n            this._timeouts.delete(path);\n            this._enqueue(path);\n        }, this.debounce));\n    }\n    async _enqueue(full) {\n        this._queue.push(full);\n        if (this._status !== 2) {\n            return;\n        }\n        this._status = 3;\n        while (this._queue.length) {\n            const full = this._queue.shift();\n            const path = full.slice(this.dir.length + 1);\n            const stats = await stat$1(full).catch(() => { });\n            if (stats) {\n                if (this.filter && !(await this.filter({ path, stats }))) {\n                    continue;\n                }\n                const isNew = !this.paths.has(path);\n                this.paths.set(path, stats);\n                if (path) {\n                    this.emit('+', { path, stats, isNew });\n                }\n                if (stats.isDirectory() && !this._watchers.has(path)) {\n                    await this._recurse(full);\n                    for (const [newPath, stats] of this.paths.entries()) {\n                        if (newPath.startsWith(path + '/')) {\n                            this.emit('+', { path: newPath, stats, isNew: true });\n                        }\n                    }\n                }\n            }\n            else if (this.paths.has(path)) {\n                const stats = this.paths.get(path);\n                this.paths.delete(path);\n                this.emit('-', { path, stats });\n                if (this._watchers.has(path)) {\n                    for (const old of this._watchers.keys()) {\n                        if (old === path || old.startsWith(path + '/')) {\n                            this._watchers.get(old).close();\n                            this._watchers.delete(old);\n                        }\n                    }\n                    for (const old of this.paths.keys()) {\n                        if (old.startsWith(path + '/')) {\n                            const stats = this.paths.get(old);\n                            this.paths.delete(old);\n                            this.emit('-', { path: old, stats });\n                        }\n                    }\n                }\n            }\n        }\n        this._status = 2;\n    }\n}\n\nexport default CheapWatch;\n//# sourceMappingURL=CheapWatch.es.js.map\n"],"names":["promisify","readdir","stat","watch"],"mappings":"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"}